---
title: "Reproducing Figure 3: Schaefer et al. (2000)"
subtitle: "EDS 214 — Analytical Workflows & Scientific Reproducibility"
format: html    
code-fold: true
author:
  - name: Jay Kim
    email: wonyoungkim@ucsb.edu
    affiliation: "UC Santa Barbara"
execute: 
  warning: false
  echo: false
---

# Install & Load Packages

Please check the following script if you do not have all the packages below installed. Please [check](https://github.com/jwonyk/EDS214-Schaefer-jwonyk/blob/main/00_Initialization.R) here.

```{r, echo=TRUE}
## Load in all the necessary packages
library(tidyverse)
library(janitor)
library(here)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(patchwork)
library(paletteer)
```

# Background

Big storms can damage forests and change what flows in streams; this project re-creates Figure 3 from Schaefer et al. (2000) to show a clear, repeatable analysis.

# ![Figure 3 from Schaefer et al. (2000)](images/original_figure-01.png){width="549"}

# Data

Weekly stream-water chemistry from the Luquillo Experimental Forest (PRM, BQ1–BQ3) around Hurricane Hugo (1989), focusing on five ions: K, NO₃-N, Mg, Ca, and NH₄-N.

```{r, echo=TRUE}
# Assign cleaned data to the variable 
bqprm_k <- read_csv(here("output", "cleaned", "bqprm_k.csv"))
bqprm_no3_n <- read_csv(here("output", "cleaned", "bqprm_no3_n.csv"))
bqprm_mg <- read_csv(here("output", "cleaned", "bqprm_mg.csv"))
bqprm_ca <- read_csv(here("output", "cleaned", "bqprm_ca.csv"))
bqprm_nh4_n <- read_csv(here("output", "cleaned", "bqprm_nh4_n.csv"))
```

# Methods

The workflow for this paper consist of: read and clean the CSVs, mark the hurricane date, and plot each ion over time. The goal is to reproducible code.

First we are going to call the function in `R/moving_average` to compute.

```{r, echo=TRUE}
# Call in the function from R folder to be used
source(here("R", "moving_average.R"))
```

All data cleaning has been completed in `R/data_cleaning.R` that includes reshape to long format, add week numbers, join sites, compute 9-week moving averages. Below is the following that has been completed in the `R/data_cleaning.R`. This code chunk is for viewing only. It will not be running in Quarto Doc.

```{r, eval=FALSE, echo=TRUE}
# Assign the data to the variable 

## Load and clean dataset from BQ1 to PRM
BQ1 <- read_csv(here("data", "raw", "QuebradaCuenca1-Bisley.csv")) %>% 
  clean_names()
BQ2 <- read_csv(here("data", "raw", "QuebradaCuenca2-Bisley.csv")) %>% 
  clean_names()
BQ3 <- read_csv(here("data", "raw", "QuebradaCuenca3-Bisley.csv")) %>% 
  clean_names()
prm <- read_csv(here("data", "raw", "RioMameyesPuenteRoto.csv")) %>% 
  clean_names()

# Call in the function from R folder to be used
source(here("R", "moving_average.R"))

# Data Cleaning

## Reshape BQ1 and PRM data to long format with weeks and nutrient concentrations
BQ1_fig_3 <-  BQ1 %>% 
  mutate(weeks = lubridate::week(sample_date)) %>% 
  pivot_longer(cols = c("k", "no3_n", "mg", "ca", "nh4_n"),
               names_to = "nutrients", values_to = "concentration") %>% 
  select(sample_date, sample_id, nutrients, concentration, weeks) %>% 
  ungroup()

BQ2_fig_3 <-  BQ2 %>% 
  mutate(weeks = lubridate::week(sample_date)) %>% 
  pivot_longer(cols = c("k", "no3_n", "mg", "ca", "nh4_n"),
               names_to = "nutrients", values_to = "concentration") %>% 
  select(sample_date, sample_id, nutrients, concentration, weeks) %>% 
  ungroup()

BQ3_fig_3 <-  BQ3 %>% 
  mutate(weeks = lubridate::week(sample_date)) %>% 
  pivot_longer(cols = c("k", "no3_n", "mg", "ca", "nh4_n"),
               names_to = "nutrients", values_to = "concentration") %>% 
  select(sample_date, sample_id, nutrients, concentration, weeks) %>% 
  ungroup()

prm_fig_3 <-  prm %>% 
  mutate(weeks = lubridate::week(sample_date)) %>% 
  pivot_longer(cols = c("k", "no3_n", "mg", "ca", "nh4_n"),
               names_to = "nutrients", values_to = "concentration") %>% 
  select(sample_date, sample_id, nutrients, concentration, weeks) %>% 
  ungroup()

## Combine all datasets and calculate rolling averages for each nutrient
bqprm <- full_join(BQ1_fig_3, BQ2_fig_3) %>%
  full_join(BQ3_fig_3) %>%
  full_join(prm_fig_3) %>% 
  group_by(sample_id, nutrients) %>% 
  relocate(weeks, .after = sample_date) %>% 
  mutate(sample_id = as.factor(sample_id), nutrients = as.factor(nutrients)) %>% 
  mutate(rolling_average = sapply(as.Date(sample_date), 
                                  moving_average, dates = as.Date(sample_date), 
                                  concentration = concentration, win_size_wks = 9))

## Filter dataset for the selected nutrients and years between 1988 to 1995
bqprm_k <- bqprm %>% 
  filter(nutrients == "k") %>% 
  filter(between(lubridate::year(sample_date), 1988, 1995))
bqprm_no3_n <- bqprm %>% 
  filter(nutrients == "no3_n") %>% 
  filter(between(lubridate::year(sample_date), 1988, 1995))
bqprm_mg <- bqprm %>% 
  filter(nutrients == "mg") %>% 
  filter(between(lubridate::year(sample_date), 1988, 1995))
bqprm_ca <- bqprm %>% 
  filter(nutrients == "ca") %>% 
  filter(between(lubridate::year(sample_date), 1988, 1995))
bqprm_nh4_n <- bqprm %>% 
  filter(nutrients == "nh4_n") %>% 
  filter(between(lubridate::year(sample_date), 1988, 1995))

# Export Data
## Saving cleaned data frames to a new CSV to data folder (change as needed)
write_csv(bqprm_k, file = here("output", "cleaned", "bqprm_k.csv"))
write_csv(bqprm_no3_n, file = here("output", "cleaned", "bqprm_no3_n.csv"))
write_csv(bqprm_mg, file = here("output", "cleaned", "bqprm_mg.csv"))
write_csv(bqprm_ca, file = here("output", "cleaned", "bqprm_ca.csv"))
write_csv(bqprm_nh4_n, file = here("output", "cleaned", "bqprm_nh4_n.csv"))
```

This is visualization. This won't be running here.

```{r, eval=FALSE, echo=TRUE}

hurricane_hugo <- as.Date("1989-09-18")
plot_k <- ggplot(bqprm_k, aes(sample_date, rolling_average, linetype = sample_id)) +
  geom_line(size = 0.4) +
  geom_vline(xintercept = hurricane_hugo, linetype = "dashed", linewidth = 0.5) +
  scale_linetype_manual(values = c("solid","dotted","longdash","dotdash")) +
  scale_x_date(limits = as.Date(c("1988-01-01","1994-12-31")),
               breaks = seq(as.Date("1988-01-01"), 
                            as.Date("1994-12-31"), 
                            by = "year"),
               date_labels = "%Y") +
  labs(y = "K mg l^-1", x = NULL, linetype = NULL) +
  theme_classic(base_size = 10) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5))

plot_no3 <- ggplot(bqprm_no3_n, aes(sample_date, rolling_average, linetype = sample_id)) +
  geom_line(size = 0.4) +
  geom_vline(xintercept = hurricane_hugo, linetype = "dashed", linewidth = 0.5) +
  scale_linetype_manual(values = c("solid","dotted","longdash","dotdash")) +
  scale_x_date(limits = as.Date(c("1988-01-01","1994-12-31")),
               breaks = seq(as.Date("1988-01-01"), 
                            as.Date("1994-12-31"), 
                            by = "year"),
               date_labels = "%Y") +
  labs(y = "NO3-N ug l^-1", x = NULL, linetype = NULL) +
  theme_classic(base_size = 10) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5))

plot_mg <- ggplot(bqprm_mg, aes(sample_date, rolling_average, linetype = sample_id)) +
  geom_line(size = 0.4) +
  geom_vline(xintercept = hurricane_hugo, linetype = "dashed", linewidth = 0.5) +
  scale_linetype_manual(values = c("solid","dotted","longdash","dotdash")) +
  scale_x_date(limits = as.Date(c("1988-01-01","1994-12-31")),
               breaks = seq(as.Date("1988-01-01"), 
                            as.Date("1994-12-31"), 
                            by = "year"),
               date_labels = "%Y") +
  labs(y = "Mg mg l^-1", x = NULL) +
  theme_classic(base_size = 10) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5))

plot_ca <- ggplot(bqprm_ca, aes(sample_date, rolling_average, linetype = sample_id)) +
  geom_line(size = 0.4) +
  geom_vline(xintercept = hurricane_hugo, linetype = "dashed", linewidth = 0.5) +
  scale_linetype_manual(values = c("solid","dotted","longdash","dotdash")) +
  scale_x_date(limits = as.Date(c("1988-01-01","1994-12-31")),
               breaks = seq(as.Date("1988-01-01"), 
                            as.Date("1994-12-31"), 
                            by = "year"),
               date_labels = "%Y") +
  labs(y = "Ca mg l^-1", x = NULL, linetype) +
  theme_classic(base_size = 10) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5))

plot_nh4 <- ggplot(bqprm_nh4_n, aes(sample_date, rolling_average, linetype = sample_id)) +
  geom_line(size = 0.4) +
  geom_vline(xintercept = hurricane_hugo, linetype = "dashed", linewidth = 0.5) +
  scale_linetype_manual(values = c("solid","dotted","longdash","dotdash")) +
  scale_x_date(limits = as.Date(c("1988-01-01","1994-12-31")),
               breaks = seq(as.Date("1988-01-01"), 
                            as.Date("1994-12-31"), 
                            by = "year"),
               date_labels = "%Y") +
  labs(y = "NH4-N ug l^-1", x = "Years", linetype = NULL) +
  theme_classic(base_size = 10) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5))

# stack and share legend
(plot_k / plot_no3 / plot_mg / plot_ca / plot_nh4) + plot_layout(guides = "collect")

ggsave(here("figs", "fig3_replica.png"))
```

# Results

The figure should mirror the paper: sharp rises in K, NO₃-N, and NH₄-N right after the hurricane that fade within \~1–2 years.

![Figure 3 Replica](images/fig3_replica.png){fig-align="center"}

# Reference

McDowell, W. and International Institute of Tropical Forestry(IITF), USDA Forest Service.. 2024. Chemistry of stream water from the Luquillo Mountains ver 4923064. Environmental Data Initiative. https://doi.org/10.6073/pasta/f31349bebdc304f758718f4798d25458 (Accessed 2025-08-29).

Schaefer, Douglas. A., William H. McDowell, Fredrick N. Scatena, and Clyde E. Asbury. 2000. “Effects of Hurricane Disturbance on Stream Water Concentrations and Fluxes in Eight Tropical Forest Watersheds of the Luquillo Experimental Forest, Puerto Rico.” Journal of Tropical Ecology 16 (2): 189–207. https://doi.org/10.1017/s0266467400001358.
